Backport of:

From c716ea9971f02979352f1b0ccb4e7a05e372c5fd Mon Sep 17 00:00:00 2001
From: Lance Wang <lzwang@suse.com>
Date: Thu, 15 Aug 2019 16:45:52 +0800
Subject: [PATCH] Add a test for issue #501 CVE-2019-11038

[Ubuntu note: Removed creation of tests/xbm/.gitignore file
 -- Avital]

---
 tests/xbm/CMakeLists.txt     |  1 +
 tests/xbm/Makemodule.am      |  5 +++-
 tests/xbm/github_bug_501.c   | 48 ++++++++++++++++++++++++++++++++++++
 tests/xbm/github_bug_501.xbm |  4 +++
 4 files changed, 57 insertions(+), 1 deletion(-)
 create mode 100644 tests/xbm/github_bug_501.c
 create mode 100644 tests/xbm/github_bug_501.xbm

--- a/tests/xbm/CMakeLists.txt
+++ b/tests/xbm/CMakeLists.txt
@@ -6,4 +6,5 @@ LIST(APPEND TESTS_FILES
 )
 ENDIF(PNG_FOUND)
 
+LIST(APPEND TESTS_FILES github_bug_501)
 ADD_GD_TESTS()
--- a/tests/xbm/Makemodule.am
+++ b/tests/xbm/Makemodule.am
@@ -5,9 +5,12 @@ libgd_test_programs += \
 	xbm/x10_basic_read
 endif
 
+libgd_test_programs += xbm/github_bug_501
+
 EXTRA_DIST += \
 	xbm/CMakeLists.txt \
 	xbm/github_bug_109.xbm \
 	xbm/github_bug_109_exp.png \
 	xbm/x10_basic_read.xbm \
-	xbm/x10_basic_read_exp.png
+	xbm/x10_basic_read_exp.png \
+	xbm/github_bug_501.xbm
--- /dev/null
+++ b/tests/xbm/github_bug_501.c
@@ -0,0 +1,48 @@
+/*
+	Test reading an invalid XBM image.
+
+	The pixels of the XBM image are invalid hex which makes the uninitialezed
+	variable be encoded into the output image i.e. information disclosure.
+	The image is 8*2.
+
+	See also <https://github.com/libgd/libgd/issues/501>.
+*/
+
+#include "gd.h"
+#include "gdtest.h"
+#ifdef _WIN32
+
+int main()
+{
+	/* skip for now */
+	return 0;
+}
+#else
+
+int main()
+{
+
+	gdImagePtr im;
+	FILE *fp;
+
+	fp = gdTestFileOpen2("xbm", "github_bug_501.xbm");
+	im = gdImageCreateFromXbm(fp);
+
+	gdTestAssert(im == NULL);
+
+	if (im) {
+		gdTestErrorMsg("Info Disclosed\n");
+		int i;
+		for (i = 0; i < 8; i++) {
+			printf("Pixel(%d, 0) %0x\n", i, gdImageGetPixel(im, i, 0));
+		}
+		for (i = 0; i < 8; i++) {
+			printf("Pixel(%d, 1) %0x\n", i, gdImageGetPixel(im, i, 1));
+		}
+		gdImageDestroy(im);
+	}
+
+	fclose(fp);
+	return gdNumFailures();
+}
+#endif
--- /dev/null
+++ b/tests/xbm/github_bug_501.xbm
@@ -0,0 +1,4 @@
+#define width 8
+#define height 2
+static char bits[] ={
+xzzxzz
